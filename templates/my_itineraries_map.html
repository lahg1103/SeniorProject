{% extends "base.html" %}

{% block head %}
{{ super() }}
<style>
    .map-page {
        min-height: 70vh;
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    #map {
        width: 100%;
        height: 60vh;
        border-radius: 1rem;
        overflow: hidden;
    }

    .map-header {
        text-align: center;
    }

    .map-header h1 {
        margin-bottom: 0.25rem;
    }

    .map-header p {
        font-size: 0.9rem;
        opacity: 0.8;
    }

    .map-legend {
        font-size: 0.8rem;
        opacity: 0.7;
        text-align: center;
    }

    .map-actions {
        display: flex;
        justify-content: center;
        gap: 1rem;
        margin-bottom: 0.5rem;
    }

    .map-button {
        border: 1px solid #222;
        padding: 0.4rem 0.9rem;
        border-radius: 999px;
        text-transform: uppercase;
        font-size: 0.8rem;
        letter-spacing: 0.08em;
        text-decoration: none;
    }
</style>
{% endblock %}

{% block body %}
<section class="landing sidepage flex-column flex-center padding map-header">
    <h1 class="hero serif center">Your Trips on the Map</h1>
    <p>Each pin represents a destination from one of your saved itineraries.</p>
</section>

<section class="itinerary-wrapper map-page padding-2x">
    <div class="map-actions">
        <a href="{{ url_for('auth.my_itineraries') }}" class="map-button">
            Back to List View
        </a>
    </div>

    <div id="map"></div>

    <p class="map-legend">
        Click a pin to see trip dates and open the full itinerary.
    </p>
</section>

<script>
    var trips = {{ trips | tojson | safe }};

    function initMap() {
        const defaultCenter = { lat: 20, lng: 0 };
        const map = new google.maps.Map(document.getElementById("map"), {
            zoom: 2,
            center: defaultCenter,
        });

        const geocoder = new google.maps.Geocoder();
        const bounds = new google.maps.LatLngBounds();

        trips.forEach((trip, index) => {
            if (!trip.destination) {
                return;
            }

            geocoder.geocode({ address: trip.destination }, (results, status) => {
                if (status === "OK" && results[0]) {
                    const location = results[0].geometry.location;
                    bounds.extend(location);

                    const marker = new google.maps.Marker({
                        map: map,
                        position: location,
                        title: trip.destination,
                    });

                    let dateText = "";
                    if (trip.arrivaldate && trip.departuredate) {
                        dateText = `<div><strong>Dates:</strong> ${trip.arrivaldate} â†’ ${trip.departuredate}</div>`;
                    }

                    let linkText = "";
                    if (trip.itinerary_id) {
                        linkText = `<div style="margin-top: 0.5rem;">
                            <a href="/itinerary/${trip.itinerary_id}">View full itinerary</a>
                        </div>`;
                    }

                    const content = `
                        <div>
                            <div><strong>${trip.destination}</strong></div>
                            ${dateText}
                            ${linkText}
                        </div>
                    `;

                    const infoWindow = new google.maps.InfoWindow({
                        content: content,
                    });

                    marker.addListener("click", () => {
                        infoWindow.open({
                            anchor: marker,
                            map,
                        });
                    });

                    if (trips.length > 1) {
                        map.fitBounds(bounds);
                    } else {
                        map.setCenter(location);
                        map.setZoom(6);
                    }
                } else {
                    console.log("Geocode failed for", trip.destination, status);
                }
            });
        });
    }

    window.initMap = initMap;
</script>

<script async defer src="https://maps.googleapis.com/maps/api/js?key={{ googleKey }}&callback=initMap">
</script>
{% endblock %}